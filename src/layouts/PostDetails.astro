---
import { render, type CollectionEntry } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Datetime from "@/components/Datetime.astro";
import { getPath } from "@/utils/getPath";
import { slugifyStr } from "@/utils/slugify";
import { SITE } from "@/config";

type Props = {
  post: CollectionEntry<"blog">;
};

const { post } = Astro.props;

const {
  title,
  author,
  description,
  ogImage: initOgImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  timezone,
  tags,
} = post.data;

const { Content } = await render(post);

let ogImageUrl: string | undefined;

// Determine OG image source
if (typeof initOgImage === "string") {
  ogImageUrl = initOgImage; // Remote OG image (absolute URL)
} else if (initOgImage?.src) {
  ogImageUrl = initOgImage.src; // Local asset
}

// Use dynamic OG image if enabled and no remote|local ogImage
if (!ogImageUrl && SITE.dynamicOgImage) {
  ogImageUrl = `${getPath(post.id, post.filePath)}/index.png`;
}

// Resolve OG image URL (or fallback to SITE.ogImage / default `og.png`)
const ogImage = ogImageUrl
  ? new URL(ogImageUrl, Astro.url.origin).href
  : undefined;

const layoutProps = {
  title: `${title} | ${SITE.title}`,
  author,
  description,
  pubDatetime,
  modDatetime,
  canonicalURL,
  ogImage,
};

const postTags = tags ?? [];
---

<Layout {...layoutProps}>
  <Header />
  <main
    id="main-content"
    class="min-h-[calc(100dvh-90px-70px)] app-layout py-10 max-[500px]:min-h-[calc(100dvh-110px-70px)]"
    data-pagefind-body
  >
    <article
      id="article"
      class="app-prose w-full max-w-app max-[500px]:text-sm max-[500px]:leading-[2.2] max-[400px]:text-xs max-[400px]:leading-[2.2]"
    >
      <div class="mb-5">
        <h1
          transition:name={slugifyStr(title.replaceAll(".", "-"))}
          class="my-0 text-4xl font-medium break-words max-[500px]:text-2xl"
        >
          {title}
        </h1>
        <div
          class="flex items-center justify-between max-[500px]:flex-col max-[500px]:items-start"
        >
          <Datetime {pubDatetime} {modDatetime} {timezone} />
          <div class="flex items-center">
            {
              postTags.map(tag => {
                const slug = slugifyStr(tag);
                return (
                  <a class="ml-5 text-sm first:ml-0" href={`/tags/${slug}`}>
                    #{tag}
                  </a>
                );
              })
            }
          </div>
        </div>
      </div>
      <Content />
    </article>
  </main>
  <Footer />
  <script is:inline>
    const addHeadingLinks = () => {
      const headings = Array.from(
        document.querySelectorAll("#article h2, #article h3, #article h4, #article h5, #article h6")
      );

      for (const heading of headings) {
        if (!heading.id) continue;
        if (heading.querySelector("a.heading-link")) continue;

        const headingText = heading.textContent?.trim() ?? "";
        heading.classList.add("group");

        const link = document.createElement("a");
        link.className =
          "heading-link ms-2 inline-flex items-center opacity-50 no-underline md:opacity-0 md:group-hover:opacity-100 md:focus-visible:opacity-100";
        link.href = `#${heading.id}`;

        const icon = document.createElement("span");
        icon.setAttribute("aria-hidden", "true");
        icon.textContent = "#";
        link.appendChild(icon);

        const srOnly = document.createElement("span");
        srOnly.className = "sr-only";
        srOnly.textContent = headingText
          ? `Section link: ${headingText}`
          : "Section link";
        link.appendChild(srOnly);

        heading.appendChild(link);
      }
    };

    const setupHeadingLinks = () => addHeadingLinks();
    document.addEventListener("astro:page-load", setupHeadingLinks);
    document.addEventListener("astro:after-swap", setupHeadingLinks);
  </script>
</Layout>
